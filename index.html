<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chef's Metric â†” US Volume Converter</title>
<style>
  :root{
    --brand:#5a2d82; --brand-2:#7c4dad; --muted:#666; --bg:#f6f6f8;
    --card:#fff; --radius:10px;
  }
  html,body{height:100%; margin:0; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
  body{background:linear-gradient(180deg, var(--bg), #f2f2f4); padding:18px; color:#222;}
  .app{max-width:1100px; margin:0 auto;}
  header{display:flex;gap:16px;align-items:center; margin-bottom:12px;}
  h1{margin:0; color:var(--brand); font-size:1.4rem;}
  p.lead{margin:0;color:var(--muted); font-size:0.95rem;}
  .controls{display:flex; gap:8px; margin:12px 0 10px; flex-wrap:wrap;}
  button{background:var(--brand); color:white; border:0; padding:8px 12px; border-radius:8px; cursor:pointer;}
  button.secondary{background:#fff; color:var(--brand); border:1px solid #ddd;}
  button.ghost{background:transparent; color:var(--brand); border:1px dashed #ddd;}
  .card{background:var(--card); border-radius:var(--radius); padding:14px; box-shadow:0 6px 18px rgba(20,20,30,0.04);}
  table{width:100%; border-collapse:collapse; margin-top:10px;}
  thead th{background:var(--brand); color:white; padding:10px; text-align:left; font-weight:600; border-top-left-radius:8px;}
  th, td{padding:8px; border-bottom:1px solid #eee; vertical-align:middle;}
  td.actions{white-space:nowrap; width:1%;}
  input[type="number"], input[type="text"], select{padding:6px; border-radius:6px; border:1px solid #ddd; width:100%; box-sizing:border-box;}
  .small{font-size:0.85rem; padding:6px 8px; border-radius:6px;}
  .muted{color:var(--muted); font-size:0.9rem;}
  .right{text-align:right;}
  .copy-btn{margin-left:6px; font-size:0.85rem; padding:4px 6px; border-radius:6px;}
  .row-actions button{margin-left:6px;}
  .controls .spacer{flex:1;}
  .grid{display:grid; gap:10px; grid-template-columns:1fr 300px;}
  @media (max-width:880px){ .grid{grid-template-columns:1fr;} thead th{font-size:0.9rem;} }
  .help{font-size:0.85rem; color:var(--muted); margin-top:8px;}
  .small-muted{color:#777; font-size:0.9rem;}
  .ingredient-manager{margin-top:12px; display:flex; gap:8px; align-items:center;}
  .danger{background:#ff6b6b;}
  .pill{display:inline-block; padding:6px 8px; background:#f1f1f6; border-radius:999px; font-size:0.85rem;}
  .sr-only{position:absolute; left:-9999px;}
</style>
</head>
<body>
<div class="app">
  <header>
    <div>
      <h1>Chef's Ingredient Converter</h1>
      <p class="lead">Translate metric weights (g/kg/ml/l) used in pro kitchens into U.S. home measurements (cups, tbsp, tsp). Densities are grams per 1 US cup.</p>
    </div>
    <div style="margin-left:auto" class="pill">1 US cup = 236.588 ml</div>
  </header>

  <div class="grid">
    <div class="card">
      <div class="controls">
        <button id="addRowBtn">âž• Add Ingredient</button>
        <button id="copyTableBtn">ðŸ“‹ Copy Entire Table</button>
        <button id="exportCSVBtn">ðŸ’¾ Export CSV</button>
        <div class="spacer"></div>
        <label class="small-muted"><input id="autoConvertToggle" type="checkbox" checked> Auto-convert</label>
      </div>

      <table id="convTable" aria-label="Conversion table">
        <thead>
          <tr>
            <th style="width:260px">Ingredient</th>
            <th style="width:90px">Amount</th>
            <th style="width:120px">Metric Unit</th>
            <th>Conversions</th>
            <th class="right">Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <p class="help">Tips: type ingredient name to search. Add custom ingredients (with density g/cup) in the manager panel at right. Copy results quickly with the small clipboard buttons.</p>
    </div>

    <aside class="card">
      <h3 style="margin-top:0">Ingredient Manager</h3>
      <p class="small-muted">Add or edit ingredient densities (grams per US cup). These are stored locally in your browser.</p>

      <div style="display:flex; gap:8px; margin-top:8px;">
        <input id="newIngName" type="text" placeholder="Ingredient name">
        <input id="newIngDensity" type="number" placeholder="g per cup" style="width:110px">
        <button id="addIngredientBtn">âž• Add</button>
      </div>

      <div id="ingList" style="margin-top:12px; max-height:280px; overflow:auto;"></div>

      <hr style="margin:12px 0">

      <div style="display:flex; gap:8px; align-items:center;">
        <button id="resetDefaults" class="secondary">Reset to Defaults</button>
        <button id="clearStorage" class="ghost">Clear Saved</button>
      </div>

      <div style="margin-top:12px">
        <strong>Saved ingredients:</strong>
        <div id="savedCount" class="muted" style="margin-top:6px"></div>
      </div>
    </aside>
  </div>
</div>

<script>
/*
  Chef's Ingredient Converter
  - grams-per-cup densities stored in localStorage (key: chef_ing_densities)
  - table rows persisted (key: chef_conv_rows) so chef can reopen
  - supports g, kg, ml, l
  - auto-convert toggle
  - copy cell / row / table and export CSV
*/

/* ---------- Defaults ---------- */
const DEFAULT_DENSITIES = {
  "All-Purpose Flour": 120,
  "Bread Flour": 125,
  "Cake Flour": 110,
  "Granulated Sugar": 200,
  "Brown Sugar (packed)": 220,
  "Powdered Sugar": 120,
  "Kosher Salt": 145,
  "Table Salt": 292,
  "Baking Soda": 230,
  "Baking Powder": 192,
  "Instant Yeast": 150,
  "Rice (uncooked)": 185,
  "Quinoa (uncooked)": 170,
  "Rolled Oats": 90,
  "Cornmeal": 160
};

/* ---------- Local storage keys ---------- */
const STORAGE_ING = 'chef_ing_densities_v1';
const STORAGE_ROWS = 'chef_conv_rows_v1';
const CUP_ML = 236.588; // US cup in ml

/* ---------- Cached DOM ---------- */
const tbody = document.querySelector('#convTable tbody');
const addRowBtn = document.getElementById('addRowBtn');
const copyTableBtn = document.getElementById('copyTableBtn');
const exportCSVBtn = document.getElementById('exportCSVBtn');
const autoConvertToggle = document.getElementById('autoConvertToggle');
const ingListEl = document.getElementById('ingList');
const savedCountEl = document.getElementById('savedCount');
const addIngredientBtn = document.getElementById('addIngredientBtn');
const newIngName = document.getElementById('newIngName');
const newIngDensity = document.getElementById('newIngDensity');
const resetDefaultsBtn = document.getElementById('resetDefaults');
const clearStorageBtn = document.getElementById('clearStorage');

/* ---------- State ---------- */
let densities = loadDensities();
let rowsState = loadRows();

/* ---------- Utilities ---------- */

// Load densities from localStorage or defaults
function loadDensities(){
  try {
    const raw = localStorage.getItem(STORAGE_ING);
    if(raw){
      const parsed = JSON.parse(raw);
      return {...DEFAULT_DENSITIES, ...parsed};
    }
  } catch(e){ console.warn('failed load densities', e); }
  return {...DEFAULT_DENSITIES};
}

// Save densities to localStorage (only custom ones stored; defaults not overwritten)
function saveDensities(customOnly = false){
  try {
    // store full set so it's simple â€” but keep separate possibility later
    localStorage.setItem(STORAGE_ING, JSON.stringify(densities));
  } catch(e){ console.warn('failed save densities', e); }
}

// Load table rows (persisted)
function loadRows(){
  try {
    const raw = localStorage.getItem(STORAGE_ROWS);
    if(raw){
      return JSON.parse(raw);
    }
  } catch(e){ console.warn('failed load rows', e); }
  return [];
}

function saveRows(){
  try {
    const toSave = Array.from(tbody.querySelectorAll('tr')).map(tr => {
      return {
        ingredient: tr.querySelector('.ing-select')?.value || '',
        amount: tr.querySelector('.amount-input')?.value || '',
        unit: tr.querySelector('.unit-select')?.value || ''
      };
    });
    localStorage.setItem(STORAGE_ROWS, JSON.stringify(toSave));
  } catch(e){ console.warn('failed save rows', e); }
}

// create element helper
function el(tag, props={}, ...children){
  const node = document.createElement(tag);
  for(const k in props){
    if(k==='class') node.className = props[k];
    else if(k === 'html') node.innerHTML = props[k];
    else node.setAttribute(k, props[k]);
  }
  for(const c of children){
    if(typeof c === 'string') node.appendChild(document.createTextNode(c));
    else if(c) node.appendChild(c);
  }
  return node;
}

// copy to clipboard safe
async function copyText(text){
  try {
    await navigator.clipboard.writeText(text);
    // small feedback (accessible)
    // flash the copy button? skipped to keep simple
  } catch(e){
    alert('Copy failed â€” please allow clipboard access or copy manually: ' + text);
  }
}

/* ---------- Table row creation & conversion ---------- */

const METRIC_UNITS = [
  {value:'g', label:'g'},
  {value:'kg', label:'kg'},
  {value:'ml', label:'ml'},
  {value:'l', label:'l'}
];

function createIngredientSelect(value = ''){
  const select = el('select', {class:'ing-select'});
  // empty / search option
  select.appendChild(el('option', {value:''}, 'â€” choose / type â€”'));
  // create options from densities sorted alphabetically
  const names = Object.keys(densities).sort((a,b)=>a.localeCompare(b));
  for(const n of names){
    const o = el('option', {value:n}, n);
    if(n === value) o.selected = true;
    select.appendChild(o);
  }
  // enable typing search (native select doesn't filter; we'll allow typing to jump)
  select.addEventListener('input', () => {
    // do nothing here; auto-convert will pick up
  });
  return select;
}

function rowToText(tr){
  const ing = tr.querySelector('.ing-select')?.value || '';
  const amt = tr.querySelector('.amount-input')?.value || '';
  const unit = tr.querySelector('.unit-select')?.value || '';
  const convCell = tr.querySelector('.conv-cell')?.textContent || '';
  return `${ing}\t${amt} ${unit}\t${convCell}`;
}

function addRow(pref = {ingredient:'', amount:'', unit:'g'}, focus=true){
  const tr = document.createElement('tr');

  // Ingredient cell (with editability: user types in and we allow custom)
  const ingTd = el('td');
  const ingSelect = createIngredientSelect(pref.ingredient);
  // allow typing to add custom name quickly (non-standard UX, but helpful)
  // We'll overlay a small input for filtering â€” easier UX: also accept direct typing to create custom on Add Ingredient
  const ingSearch = el('input', {type:'text', placeholder:'Search / type ingredient', class:'ing-search'});
  ingSearch.value = pref.ingredient || '';
  // sync typed text to select if matches option otherwise leave blank
  ingSearch.addEventListener('input', (ev)=>{
    const txt = ev.target.value.trim();
    let matched = false;
    for(const opt of ingSelect.options){
      if(opt.value.toLowerCase() === txt.toLowerCase()){
        ingSelect.value = opt.value;
        matched = true;
        break;
      }
    }
    if(!matched) ingSelect.value = '';
    if(autoConvertToggle.checked) convertRow(tr);
  });
  // when select changes, update search text
  ingSelect.addEventListener('change', ()=>{
    ingSearch.value = ingSelect.value;
    if(autoConvertToggle.checked) convertRow(tr);
  });

  ingTd.appendChild(ingSearch);
  ingTd.appendChild(ingSelect);
  tr.appendChild(ingTd);

  // Amount
  const amtTd = el('td');
  const amtInput = el('input', {type:'number', step:'0.01', class:'amount-input', placeholder:'0'});
  amtInput.value = pref.amount || '';
  amtInput.addEventListener('input', ()=>{ if(autoConvertToggle.checked) convertRow(tr); });
  amtTd.appendChild(amtInput);
  tr.appendChild(amtTd);

  // Unit
  const unitTd = el('td');
  const unitSelect = el('select', {class:'unit-select'});
  for(const u of METRIC_UNITS){
    const o = el('option', {value:u.value}, u.label);
    if(u.value === (pref.unit || 'g')) o.selected=true;
    unitSelect.appendChild(o);
  }
  unitSelect.addEventListener('change', ()=>{ if(autoConvertToggle.checked) convertRow(tr); });
  unitTd.appendChild(unitSelect);
  tr.appendChild(unitTd);

  // Conversions cell
  const convTd = el('td', {class:'conv-cell'}, 'â€”');
  tr.appendChild(convTd);

  // Actions
  const actionsTd = el('td', {class:'actions right'});
  const convertBtn = el('button', {type:'button', class:'small'}, 'Convert');
  convertBtn.addEventListener('click', ()=>convertRow(tr));

  const copyRowBtn = el('button', {type:'button', class:'small copy-btn'}, 'Copy Row');
  copyRowBtn.addEventListener('click', ()=>copyText(rowToText(tr)));

  const removeBtn = el('button', {type:'button', class:'small danger'}, 'Remove');
  removeBtn.style.background = '#f2f2f4'; removeBtn.style.color = '#b33';
  removeBtn.addEventListener('click', ()=>{
    tr.remove();
    saveRows();
    renderSavedCount();
  });

  actionsTd.appendChild(convertBtn);
  actionsTd.appendChild(copyRowBtn);
  actionsTd.appendChild(removeBtn);
  tr.appendChild(actionsTd);

  tbody.appendChild(tr);

  // initial attempt to convert if auto mode or pref
  if(pref.amount && pref.ingredient) convertRow(tr);

  if(focus){
    tr.querySelector('.ing-search').focus();
  }

  // persist
  saveRows();
  renderSavedCount();
  return tr;
}

// conversion algorithm:
// - if mass unit (g / kg): grams = amount * (unit multiplier)
// - if volume unit (ml / l): convert to grams via density: grams = ml * (gramsPerCup / CUP_ML)
// - cups = grams / gramsPerCup
// - tbsp = cups * 16
// - tsp = tbsp * 3
function convertRow(tr){
  const ingName = tr.querySelector('.ing-select')?.value || tr.querySelector('.ing-search')?.value.trim();
  const amtRaw = tr.querySelector('.amount-input')?.value;
  const unit = tr.querySelector('.unit-select')?.value;

  const convCell = tr.querySelector('.conv-cell');

  if(!ingName){
    convCell.textContent = 'Select ingredient';
    return;
  }
  const density = densities[ingName];
  if(!density){
    convCell.textContent = 'Unknown density â€” add it in manager';
    return;
  }

  const amt = parseFloat(amtRaw);
  if(isNaN(amt) || amt <= 0){
    convCell.textContent = 'Enter amount';
    return;
  }

  // compute grams
  let grams;
  if(unit === 'g') grams = amt;
  else if(unit === 'kg') grams = amt * 1000;
  else if(unit === 'ml') {
    // convert ml to grams using gramsPerCup / mlPerCup
    // grams = ml * (g_per_cup / ml_per_cup)
    grams = amt * (density / CUP_ML);
  } else if(unit === 'l') {
    grams = (amt * 1000) * (density / CUP_ML);
  } else { grams = amt; }

  // calculations (step-by-step per decision boundary instructions)
  // cups = grams / gramsPerCup
  const cups = grams / density;
  // tbsp = cups * 16
  const tbsp = cups * 16;
  // tsp = tbsp * 3
  const tsp = tbsp * 3;

  // rounding sensible:
  const cupsFmt = roundTo(cups, 3); // show 3 decimals for precision
  const tbspFmt = roundTo(tbsp, 2);
  const tspFmt = roundTo(tsp, 2);

  // create small copy buttons for each
  convCell.innerHTML = `
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <div>${cupsFmt} cup(s) <button class="copy-btn" data-copy="${cupsFmt} cup(s)">ðŸ“‹</button></div>
      <div>${tbspFmt} tbsp <button class="copy-btn" data-copy="${tbspFmt} tbsp">ðŸ“‹</button></div>
      <div>${tspFmt} tsp <button class="copy-btn" data-copy="${tspFmt} tsp">ðŸ“‹</button></div>
      <div class="muted" style="margin-left:8px">(${grams.toFixed(1)} g)</div>
    </div>
  `;

  // attach event listeners for these copy buttons (delegated approach below also catches it)
  saveRows();
}

// small helper to round numbers to n decimals, preserving trailing zeros if needed
function roundTo(num, decimals){
  const factor = Math.pow(10, decimals);
  return (Math.round((num + Number.EPSILON) * factor) / factor).toFixed(decimals);
}

/* ---------- Ingredient Manager (add/edit/delete) ---------- */

function renderIngredientList(){
  ingListEl.innerHTML = '';
  const names = Object.keys(densities).sort((a,b)=>a.localeCompare(b));
  for(const n of names){
    const row = el('div', {style:'display:flex; gap:8px; align-items:center; margin-bottom:6px;'});
    const nameSpan = el('div', {style:'flex:1; font-weight:600'}, n);
    const densInput = el('input', {type:'number', value:densities[n], style:'width:100px'});
    densInput.addEventListener('change', (e)=>{
      const val = parseFloat(e.target.value);
      if(!isNaN(val) && val > 0){
        densities[n] = val;
        saveDensities();
        // if an existing table row uses this ingredient, re-convert if auto
        if(autoConvertToggle.checked) {
          for(const tr of tbody.querySelectorAll('tr')) {
            const ing = tr.querySelector('.ing-select')?.value || tr.querySelector('.ing-search')?.value;
            if(ing === n) convertRow(tr);
          }
        }
      } else {
        e.target.value = densities[n];
        alert('Density must be a positive number (grams per cup)');
      }
    });

    const deleteBtn = el('button', {class:'small'}, 'Delete');
    deleteBtn.style.background = '#fff';
    deleteBtn.addEventListener('click', ()=>{
      if(!confirm(`Delete ingredient "${n}"? This will remove it from the list.`)) return;
      delete densities[n];
      saveDensities();
      renderIngredientList();
      // reset table rows that used it
      for(const tr of tbody.querySelectorAll('tr')){
        const ing = tr.querySelector('.ing-select')?.value || tr.querySelector('.ing-search')?.value;
        if(ing === n){
          tr.querySelector('.ing-select').value = '';
          tr.querySelector('.ing-search').value = '';
          tr.querySelector('.conv-cell').textContent = 'Unknown density';
        }
      }
      saveRows();
    });

    row.appendChild(nameSpan);
    row.appendChild(densInput);
    row.appendChild(deleteBtn);
    ingListEl.appendChild(row);
  }
  renderSavedCount();
}

function renderSavedCount(){
  savedCountEl.textContent = `${Object.keys(densities).length} ingredients saved locally`;
}

addIngredientBtn.addEventListener('click', ()=>{
  const name = newIngName.value.trim();
  const dens = parseFloat(newIngDensity.value);
  if(!name) return alert('Enter a name');
  if(isNaN(dens) || dens <= 0) return alert('Enter a valid density (g per cup)');
  densities[name] = dens;
  saveDensities();
  newIngName.value=''; newIngDensity.value='';
  renderIngredientList();
  // re-render selects in table to include the new one
  updateSelects();
});

resetDefaultsBtn.addEventListener('click', ()=>{
  if(!confirm('Reset to default density list? This will overwrite local custom densities.')) return;
  densities = {...DEFAULT_DENSITIES};
  saveDensities();
  renderIngredientList();
  updateSelects();
});

clearStorageBtn.addEventListener('click', ()=>{
  if(!confirm('Clear saved densities and table rows from localStorage?')) return;
  localStorage.removeItem(STORAGE_ING);
  localStorage.removeItem(STORAGE_ROWS);
  densities = {...DEFAULT_DENSITIES};
  rowsState = [];
  tbody.innerHTML = '';
  saveDensities();
  renderIngredientList();
  renderSavedCount();
});

/* ---------- copy/export ---------- */

copyTableBtn.addEventListener('click', async ()=>{
  const rows = Array.from(tbody.querySelectorAll('tr')).map(rowToText);
  const header = "Ingredient\tAmount\tConversions";
  const text = [header, ...rows].join("\n");
  await copyText(text);
  alert('Table copied to clipboard');
});

exportCSVBtn.addEventListener('click', ()=>{
  const rows = Array.from(tbody.querySelectorAll('tr')).map(tr => {
    const ing = tr.querySelector('.ing-select')?.value || tr.querySelector('.ing-search')?.value;
    const amt = tr.querySelector('.amount-input')?.value;
    const unit = tr.querySelector('.unit-select')?.value;
    const conv = tr.querySelector('.conv-cell')?.textContent || '';
    return [ing, amt, unit, conv].map(s => `"${String(s).replace(/"/g,'""')}"`).join(',');
  });
  const csv = ['"Ingredient","Amount","Unit","Conversions"', ...rows].join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `ingredient_conversions_${new Date().toISOString().slice(0,10)}.csv`; a.click();
  URL.revokeObjectURL(url);
});

/* ---------- global event delegation for copy buttons inside conversion cells ---------- */
document.addEventListener('click', (ev)=>{
  const btn = ev.target.closest('.copy-btn');
  if(btn && btn.dataset && btn.dataset.copy){
    copyText(btn.dataset.copy);
    // optional small visual feedback
    btn.textContent = 'âœ…';
    setTimeout(()=> btn.textContent = 'ðŸ“‹', 700);
  }
});

/* ---------- update selects when densities change / initial render ---------- */
function updateSelects(){
  // for each select in table, attempt to replace options while preserving value
  const names = Object.keys(densities).sort((a,b)=>a.localeCompare(b));
  for(const sel of tbody.querySelectorAll('.ing-select')){
    const prev = sel.value;
    sel.innerHTML = '';
    sel.appendChild(el('option',{value:''}, 'â€” choose / type â€”'));
    for(const n of names){
      const o = el('option', {value:n}, n);
      if(n === prev) o.selected=true;
      sel.appendChild(o);
    }
  }
}

/* ---------- top-level controls ---------- */
addRowBtn.addEventListener('click', ()=> addRow({ingredient:'',amount:'',unit:'g'}, true));

autoConvertToggle.addEventListener('change', ()=>{
  // if toggled on, convert all rows where possible
  if(autoConvertToggle.checked){
    for(const tr of tbody.querySelectorAll('tr')) convertRow(tr);
  }
  saveRows();
});

/* ---------- persist table on change (debounced) ---------- */
let saveTimer = null;
tbody.addEventListener('input', ()=> {
  if(saveTimer) clearTimeout(saveTimer);
  saveTimer = setTimeout(()=> {
    saveRows();
    saveTimer = null;
  }, 450);
});

/* ---------- initial hydration from saved rows ---------- */
function hydrateRows(){
  const saved = loadRows();
  if(saved && saved.length){
    for(const r of saved){
      addRow(r, false);
    }
  } else {
    // if empty, add a starter row to guide the chef
    addRow({ingredient:'All-Purpose Flour', amount:'100', unit:'g'}, false);
  }
}

/* ---------- init ---------- */
(function init(){
  renderIngredientList();
  hydrateRows();
  // wire up updateSelects in case density list expanded
  updateSelects();
})();

/* ---------- small accessibility helpers ---------- */
function alert(msg){ window.setTimeout(()=> window.alert(msg), 10); }

</script>
</body>
</html>
