<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chef's Ingredient Converter</title>
<style>
  :root{
    --brand:#5a2d82; --muted:#666; --bg:#f6f6f8;
    --card:#fff; --radius:10px;
  }
  html,body{height:100%; margin:0; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
  body{background:linear-gradient(180deg, var(--bg), #f2f2f4); padding:18px; color:#222;}
  .app{max-width:1100px; margin:0 auto;}
  header{display:flex;gap:16px;align-items:center; margin-bottom:12px;}
  h1{margin:0; color:var(--brand); font-size:1.4rem;}
  p.lead{margin:0;color:var(--muted); font-size:0.95rem;}
  .controls{display:flex; gap:8px; margin:12px 0 10px; flex-wrap:wrap;}
  button{background:var(--brand); color:white; border:0; padding:8px 12px; border-radius:8px; cursor:pointer;}
  button.secondary{background:#fff; color:var(--brand); border:1px solid #ddd;}
  button.ghost{background:transparent; color:var(--brand); border:1px dashed #ddd;}
  .card{background:var(--card); border-radius:var(--radius); padding:14px; box-shadow:0 6px 18px rgba(20,20,30,0.04);}
  table{width:100%; border-collapse:collapse; margin-top:10px; table-layout: fixed;}
  thead th{background:var(--brand); color:white; padding:10px; text-align:left; font-weight:600;}
  th, td{padding:8px; border-bottom:1px solid #eee; vertical-align:middle;}
  td.actions{white-space:nowrap; width:1%;}
  input[type="number"], input[type="text"], select{padding:6px; border-radius:6px; border:1px solid #ddd; width:100%; box-sizing:border-box;}
  .small{font-size:0.85rem; padding:6px 8px; border-radius:6px;}
  .muted{color:var(--muted); font-size:0.9rem;}
  .right{text-align:right;}
  .copy-btn{margin-right:6px; font-size:0.85rem; padding:4px 6px; border-radius:6px;}
  .controls .spacer{flex:1;}
  .help{font-size:0.85rem; color:var(--muted); margin-top:8px;}
  .small-muted{color:#777; font-size:0.9rem;}
  .ingredient-manager{margin-top:18px; display:block; }
  .pill{display:inline-block; padding:6px 8px; background:#f1f1f6; border-radius:999px; font-size:0.85rem;}
  .conv-block { display:inline-flex; align-items:center; gap:8px; padding:6px; border-radius:6px; background:#fafafa; margin-right:6px; }
  .conv-copy { background:#eef; border-radius:6px; padding:4px 6px; cursor:pointer; border:1px solid #dde; font-size:0.85rem; }
  td.conv-cell { white-space:nowrap; overflow:visible; font-feature-settings: "tnum"; }
  /* a slightly larger conversions column so it gets priority in small layouts */
  th.col-ingredient{width:30%;}
  th.col-amount{width:12%;}
  th.col-unit{width:12%;}
  th.col-conversions{width:46%;}
  @media (max-width:640px){
    table { table-layout:auto; }
    td.conv-cell { overflow-x:auto; }
    th.col-ingredient{width:36%;}
    th.col-conversions{width:50%;}
  }
</style>
</head>
<body>
<div class="app">
  <header>
    <div style="flex:1;">
      <h1>Chef's Ingredient Converter</h1>
      <p class="lead">Translate metric weights (g/kg/ml/l) used in pro kitchens into U.S. home measures (cups, tbsp, tsp).</p>
    </div>
    <div style="margin-left:auto" class="pill">1 US cup = 236.588 ml</div>
  </header>

  <div class="card" id="mainCard">
    <div class="controls">
      <button id="addRowBtn">âž• Add Ingredient</button>
      <button id="copyTableBtn">ðŸ“‹ Copy Entire Table</button>
      <button id="exportCSVBtn">ðŸ’¾ Export CSV</button>
      <div class="spacer"></div>
      <label class="small-muted"><input id="autoConvertToggle" type="checkbox" checked> Auto-convert</label>
    </div>

    <table id="convTable" aria-label="Conversion table">
      <thead>
        <tr>
          <th class="col-ingredient">Ingredient</th>
          <th class="col-amount">Amount</th>
          <th class="col-unit">Metric Unit</th>
          <th class="col-conversions">Conversions</th>
          <th class="right">Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <p class="help">Tip: Use the "Override name" to label the ingredient for copying/exporting. Select the density using the ingredient dropdown (density is grams per US cup).</p>

    <!-- Ingredient Manager BELOW the conversion table -->
    <div class="ingredient-manager card" id="managerCard" style="margin-top:18px;">
      <h3 style="margin-top:0">Ingredient Manager</h3>
      <p class="small-muted">Add or edit ingredient densities (grams per US cup). Data saved locally in your browser.</p>

      <div style="display:flex; gap:8px; margin-top:8px;">
        <input id="newIngName" type="text" placeholder="Ingredient name">
        <input id="newIngDensity" type="number" placeholder="g per cup" style="width:140px">
        <button id="addIngredientBtn">âž• Add</button>
      </div>

      <div id="ingList" style="margin-top:12px; max-height:220px; overflow:auto;"></div>

      <hr style="margin:12px 0">

      <div style="display:flex; gap:8px; align-items:center;">
        <button id="resetDefaults" class="secondary">Reset to Defaults</button>
        <button id="clearStorage" class="ghost">Clear Saved</button>
      </div>

      <div style="margin-top:12px">
        <strong>Saved ingredients:</strong>
        <div id="savedCount" class="muted" style="margin-top:6px"></div>
      </div>
    </div>
  </div>
</div>

<script>
/*
  Chef's Ingredient Converter - single-file
  - Works as static site (Github Pages)
  - Persistent densities and rows in localStorage
  - Override name used for copy/export/print
  - Copy buttons on left of each conversion block
  - Defensive clipboard handling + fallback
*/

/* ----- Defaults and constants ----- */
const DEFAULT_DENSITIES = {
  "All-Purpose Flour": 120,
  "Bread Flour": 125,
  "Cake Flour": 110,
  "Granulated Sugar": 200,
  "Brown Sugar (packed)": 220,
  "Powdered Sugar": 120,
  "Kosher Salt": 145,
  "Table Salt": 292,
  "Baking Soda": 230,
  "Baking Powder": 192,
  "Instant Yeast": 150,
  "Rice (uncooked)": 185,
  "Quinoa (uncooked)": 170,
  "Rolled Oats": 90,
  "Cornmeal": 160
};

const STORAGE_ING = 'chef_ing_densities_v1';
const STORAGE_ROWS = 'chef_conv_rows_v1';
const CUP_ML = 236.588;

const METRIC_UNITS = [
  {value:'g', label:'g'},
  {value:'kg', label:'kg'},
  {value:'ml', label:'ml'},
  {value:'l', label:'l'}
];

/* ----- Cached DOM references ----- */
const tbody = document.querySelector('#convTable tbody');
const addRowBtn = document.getElementById('addRowBtn');
const copyTableBtn = document.getElementById('copyTableBtn');
const exportCSVBtn = document.getElementById('exportCSVBtn');
const autoConvertToggle = document.getElementById('autoConvertToggle');
const ingListEl = document.getElementById('ingList');
const savedCountEl = document.getElementById('savedCount');
const addIngredientBtn = document.getElementById('addIngredientBtn');
const newIngName = document.getElementById('newIngName');
const newIngDensity = document.getElementById('newIngDensity');
const resetDefaultsBtn = document.getElementById('resetDefaults');
const clearStorageBtn = document.getElementById('clearStorage');

/* ----- State ----- */
let densities = loadDensities(); // object name -> grams per cup

/* ----- Utilities ----- */
function loadDensities(){
  try {
    const raw = localStorage.getItem(STORAGE_ING);
    if(raw){
      const parsed = JSON.parse(raw);
      return {...DEFAULT_DENSITIES, ...parsed};
    }
  } catch(e){ console.warn('loadDensities error', e); }
  return {...DEFAULT_DENSITIES};
}
function saveDensities(){ try{ localStorage.setItem(STORAGE_ING, JSON.stringify(densities)); } catch(e){ console.warn(e); } }
function loadRows(){
  try {
    const raw = localStorage.getItem(STORAGE_ROWS);
    if(raw) return JSON.parse(raw);
  } catch(e){ console.warn('loadRows error', e); }
  return [];
}
function saveRows(){
  try {
    const toSave = Array.from(tbody.querySelectorAll('tr')).map(tr => {
      return {
        ingredient: tr.querySelector('.ing-select')?.value || '',
        override: tr.querySelector('.override-input')?.value || '',
        amount: tr.querySelector('.amount-input')?.value || '',
        unit: tr.querySelector('.unit-select')?.value || ''
      };
    });
    localStorage.setItem(STORAGE_ROWS, JSON.stringify(toSave));
  } catch(e){ console.warn('saveRows error', e); }
}

/* small element factory */
function el(tag, props={}, ...children){
  const node = document.createElement(tag);
  for(const k in props){
    if(k==='class') node.className = props[k];
    else if(k==='html') node.innerHTML = props[k];
    else node.setAttribute(k, props[k]);
  }
  for(const c of children){
    if(typeof c === 'string') node.appendChild(document.createTextNode(c));
    else if(c) node.appendChild(c);
  }
  return node;
}

/* ----- UI: create ingredient select (populated from densities) ----- */
function createIngredientSelect(value=''){
  const select = el('select', {class:'ing-select'});
  select.appendChild(el('option',{value:''}, 'â€” pick ingredient â€”'));
  const names = Object.keys(densities).sort((a,b)=>a.localeCompare(b));
  for(const n of names){
    const o = el('option',{value:n}, n);
    if(n === value) o.selected = true;
    select.appendChild(o);
  }
  select.addEventListener('change', ()=> {
    // do not overwrite override input; conversion will update if auto enabled
    const tr = select.closest('tr');
    if(tr && autoConvertToggle.checked) convertRow(tr);
  });
  return select;
}

/* ----- Add row (creates full DOM row, hooks up events) ----- */
function addRow(pref={ingredient:'', override:'', amount:'', unit:'g'}, focus=true){
  const tr = document.createElement('tr');

  // Ingredient column: override input + select (select picks density used)
  const ingTd = el('td');
  const overrideInput = el('input', {type:'text', placeholder:'Override name (optional)', class:'override-input'});
  overrideInput.value = pref.override || '';
  overrideInput.addEventListener('input', ()=> { if(autoConvertToggle.checked) convertRow(tr); });

  const ingSelect = createIngredientSelect(pref.ingredient || '');
  ingTd.appendChild(overrideInput);
  ingTd.appendChild(ingSelect);
  tr.appendChild(ingTd);

  // Amount
  const amtTd = el('td');
  const amtInput = el('input', {type:'number', step:'0.01', class:'amount-input', placeholder:'0'});
  amtInput.value = pref.amount || '';
  amtInput.addEventListener('input', ()=> { if(autoConvertToggle.checked) convertRow(tr); });
  amtTd.appendChild(amtInput);
  tr.appendChild(amtTd);

  // Unit
  const unitTd = el('td');
  const unitSelect = el('select', {class:'unit-select'});
  for(const u of METRIC_UNITS){
    const o = el('option', {value:u.value}, u.label);
    if(u.value === (pref.unit || 'g')) o.selected=true;
    unitSelect.appendChild(o);
  }
  unitSelect.addEventListener('change', ()=> { if(autoConvertToggle.checked) convertRow(tr); });
  unitTd.appendChild(unitSelect);
  tr.appendChild(unitTd);

  // Conversions cell
  const convTd = el('td', {class:'conv-cell'}, 'â€”');
  tr.appendChild(convTd);

  // Actions: Convert / Copy Row / Remove
  const actionsTd = el('td', {class:'actions right'});
  const convertBtn = el('button', {type:'button', class:'small'}, 'Convert');
  convertBtn.addEventListener('click', ()=> convertRow(tr));

  const copyRowBtn = el('button', {type:'button', class:'small'}, 'Copy Row');
  copyRowBtn.addEventListener('click', ()=> copyRow(tr));

  const removeBtn = el('button', {type:'button', class:'small'}, 'Remove');
  removeBtn.style.background = '#fff'; removeBtn.style.color = '#b33';
  removeBtn.addEventListener('click', ()=> { tr.remove(); saveRows(); renderSavedCount(); });

  actionsTd.appendChild(convertBtn);
  actionsTd.appendChild(copyRowBtn);
  actionsTd.appendChild(removeBtn);
  tr.appendChild(actionsTd);

  tbody.appendChild(tr);

  if(pref.ingredient && pref.amount) convertRow(tr);
  if(focus) overrideInput.focus();
  saveRows();
  renderSavedCount();
  return tr;
}

/* ----- Conversions ----- */
function roundTo(num, decimals){
  const factor = Math.pow(10, decimals);
  return (Math.round((num + Number.EPSILON) * factor) / factor).toFixed(decimals);
}

function convertRow(tr){
  if(!tr) return;
  const overrideName = tr.querySelector('.override-input')?.value.trim();
  const ingSelect = tr.querySelector('.ing-select');
  const ingredient = ingSelect?.value || '';
  const amountStr = tr.querySelector('.amount-input')?.value;
  const unit = tr.querySelector('.unit-select')?.value;
  const convCell = tr.querySelector('.conv-cell');

  if(!ingredient){
    convCell.textContent = 'Pick ingredient';
    return;
  }
  const density = densities[ingredient];
  if(!density){
    convCell.textContent = 'Unknown density â€” add it below';
    return;
  }
  const amount = parseFloat(amountStr);
  if(isNaN(amount) || amount <= 0){
    convCell.textContent = 'Enter amount';
    return;
  }

  // compute grams
  let grams;
  if(unit === 'g') grams = amount;
  else if(unit === 'kg') grams = amount * 1000;
  else if(unit === 'ml') grams = amount * (density / CUP_ML);
  else if(unit === 'l') grams = (amount * 1000) * (density / CUP_ML);
  else grams = amount;

  const cups = grams / density;
  const tbsp = cups * 16;
  const tsp = tbsp * 3;

  const cupsFmt = roundTo(cups, 3);
  const tbspFmt = roundTo(tbsp, 2);
  const tspFmt = roundTo(tsp, 2);

  // Build conversions with copy buttons to the LEFT of each value (user requested)
  const displayName = overrideName || ingredient;
  convCell.innerHTML = `
    <div style="display:flex;flex-wrap:nowrap;gap:8px;align-items:center;">
      <div class="conv-block"><button class="conv-copy" data-copy="${escapeForClipboard(displayName)}\t${cupsFmt} cup(s)">${'ðŸ“‹'}</button><div>${cupsFmt} cup(s)</div></div>
      <div class="conv-block"><button class="conv-copy" data-copy="${escapeForClipboard(displayName)}\t${tbspFmt} tbsp">${'ðŸ“‹'}</button><div>${tbspFmt} tbsp</div></div>
      <div class="conv-block"><button class="conv-copy" data-copy="${escapeForClipboard(displayName)}\t${tspFmt} tsp">${'ðŸ“‹'}</button><div>${tspFmt} tsp</div></div>
      <div class="small-muted" style="margin-left:6px">(${grams.toFixed(1)} g)</div>
    </div>
  `;
  saveRows();
}

/* escape tabs/newlines for clipboard-safe single-line */
function escapeForClipboard(text){
  return String(text).replace(/\s+/g,' ').replace(/"/g,'"');
}

/* ----- Copy & Export helpers ----- */
async function copyText(text){
  // navigator.clipboard is best, but must be in secure context. fallback to textarea execCommand
  try {
    if(navigator.clipboard && navigator.clipboard.writeText){
      await navigator.clipboard.writeText(text);
      return true;
    }
  } catch(e){ console.warn('clipboard write failed', e); }
  // fallback
  try {
    const ta = document.createElement('textarea');
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    ta.remove();
    return true;
  } catch(e){
    console.warn('fallback copy failed', e);
    return false;
  }
}

function rowToDisplayText(tr){
  const override = tr.querySelector('.override-input')?.value.trim();
  const ing = tr.querySelector('.ing-select')?.value || '';
  const displayName = override || ing || '(untitled)';
  const amt = tr.querySelector('.amount-input')?.value || '';
  const unit = tr.querySelector('.unit-select')?.value || '';
  const convText = tr.querySelector('.conv-cell')?.textContent || '';
  return `${displayName}\t${amt} ${unit}\t${convText}`;
}

function copyRow(tr){
  const text = rowToDisplayText(tr);
  copyText(text).then(ok => {
    if(ok) alert('Row copied to clipboard');
    else alert('Copy failed â€” try selecting the content manually.');
  });
}

/* Full table copy */
copyTableBtn.addEventListener('click', async ()=>{
  const rows = Array.from(tbody.querySelectorAll('tr')).map(rowToDisplayText);
  const header = "Ingredient\tAmount\tConversions";
  const text = [header, ...rows].join("\n");
  const ok = await copyText(text);
  if(ok) alert('Table copied to clipboard');
  else alert('Copy failed â€” try exporting CSV instead.');
});

/* CSV export */
exportCSVBtn.addEventListener('click', ()=>{
  const rows = Array.from(tbody.querySelectorAll('tr')).map(tr => {
    const override = tr.querySelector('.override-input')?.value.trim();
    const ing = tr.querySelector('.ing-select')?.value || '';
    const display = override || ing || '';
    const amt = tr.querySelector('.amount-input')?.value || '';
    const unit = tr.querySelector('.unit-select')?.value || '';
    const conv = tr.querySelector('.conv-cell')?.textContent || '';
    return [display, amt, unit, conv].map(s => `"${String(s).replace(/"/g,'""')}"`).join(',');
  });
  const csv = ['"Ingredient","Amount","Unit","Conversions"', ...rows].join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `ingredient_conversions_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  URL.revokeObjectURL(url);
});

/* ----- Ingredient Manager UI ----- */
function renderIngredientList(){
  ingListEl.innerHTML = '';
  const names = Object.keys(densities).sort((a,b)=>a.localeCompare(b));
  for(const n of names){
    const row = el('div', {style:'display:flex; gap:8px; align-items:center; margin-bottom:6px;'});
    const nameSpan = el('div', {style:'flex:1; font-weight:600'}, n);
    const densInput = el('input', {type:'number', value:densities[n], style:'width:100px'});
    densInput.addEventListener('change', (e)=>{
      const val = parseFloat(e.target.value);
      if(!isNaN(val) && val > 0){
        densities[n] = val;
        saveDensities();
        if(autoConvertToggle.checked){
          for(const tr of tbody.querySelectorAll('tr')){
            const sel = tr.querySelector('.ing-select');
            if(sel && sel.value === n) convertRow(tr);
          }
        }
      } else {
        e.target.value = densities[n];
        alert('Density must be a positive number (grams per cup)');
      }
    });

    const deleteBtn = el('button', {class:'small'}, 'Delete');
    deleteBtn.style.background = '#fff';
    deleteBtn.addEventListener('click', ()=>{
      if(!confirm(`Delete ingredient "${n}"?`)) return;
      delete densities[n];
      saveDensities();
      renderIngredientList();
      updateSelects();
      for(const tr of tbody.querySelectorAll('tr')){
        const sel = tr.querySelector('.ing-select');
        if(sel && sel.value === n){
          sel.value = '';
          tr.querySelector('.conv-cell').textContent = 'Unknown density';
        }
      }
      saveRows();
    });

    row.appendChild(nameSpan);
    row.appendChild(densInput);
    row.appendChild(deleteBtn);
    ingListEl.appendChild(row);
  }
  renderSavedCount();
}

function renderSavedCount(){
  savedCountEl.textContent = `${Object.keys(densities).length} ingredients saved locally`;
}

/* Add ingredient button handler */
addIngredientBtn.addEventListener('click', ()=>{
  const name = newIngName.value.trim();
  const dens = parseFloat(newIngDensity.value);
  if(!name) return alert('Enter an ingredient name');
  if(isNaN(dens) || dens <= 0) return alert('Enter a valid density (g per cup)');
  densities[name] = dens;
  saveDensities();
  newIngName.value=''; newIngDensity.value='';
  renderIngredientList();
  updateSelects();
});

/* Reset defaults / clear storage handlers */
resetDefaultsBtn.addEventListener('click', ()=>{
  if(!confirm('Reset to default density list? This will overwrite local custom densities.')) return;
  densities = {...DEFAULT_DENSITIES};
  saveDensities();
  renderIngredientList();
  updateSelects();
});

clearStorageBtn.addEventListener('click', ()=>{
  if(!confirm('Clear saved densities and table rows from localStorage?')) return;
  localStorage.removeItem(STORAGE_ING);
  localStorage.removeItem(STORAGE_ROWS);
  densities = {...DEFAULT_DENSITIES};
  tbody.innerHTML = '';
  saveDensities();
  renderIngredientList();
  renderSavedCount();
});

/* ----- Update selects after densities change ----- */
function updateSelects(){
  const names = Object.keys(densities).sort((a,b)=>a.localeCompare(b));
  for(const sel of tbody.querySelectorAll('.ing-select')){
    const prev = sel.value;
    sel.innerHTML = '';
    sel.appendChild(el('option',{value:''}, 'â€” pick ingredient â€”'));
    for(const n of names){
      const o = el('option',{value:n}, n);
      if(n === prev) o.selected=true;
      sel.appendChild(o);
    }
  }
}

/* ----- Hydrate rows from localStorage on load ----- */
function hydrateRows(){
  const saved = loadRows();
  if(saved && saved.length){
    for(const r of saved){
      addRow({ingredient:r.ingredient || '', override:r.override || '', amount:r.amount || '', unit:r.unit || 'g'}, false);
    }
  } else {
    addRow({ingredient:'All-Purpose Flour', override:'', amount:'100', unit:'g'}, false);
  }
}

/* ----- Global delegated copy handler for conv-copy buttons ----- */
document.addEventListener('click', (ev)=>{
  const copyBtn = ev.target.closest('.conv-copy');
  if(copyBtn && copyBtn.dataset && copyBtn.dataset.copy){
    copyText(copyBtn.dataset.copy).then(ok => {
      const old = copyBtn.textContent;
      if(ok){
        copyBtn.textContent = 'âœ…';
        setTimeout(()=> copyBtn.textContent = old, 700);
      } else {
        alert('Copy failed â€” please try selecting the text manually.');
      }
    });
  }
});

/* ----- Hook up main controls ----- */
addRowBtn.addEventListener('click', ()=> addRow({ingredient:'', override:'', amount:'', unit:'g'}, true));
autoConvertToggle.addEventListener('change', ()=> {
  if(autoConvertToggle.checked){
    for(const tr of tbody.querySelectorAll('tr')) convertRow(tr);
  }
  saveRows();
});

/* debounce saving rows on input */
let saveTimer = null;
tbody.addEventListener('input', ()=> {
  if(saveTimer) clearTimeout(saveTimer);
  saveTimer = setTimeout(()=> { saveRows(); saveTimer = null; }, 450);
});

/* ----- Init ----- */
(function init(){
  renderIngredientList();
  hydrateRows();
  updateSelects();
})();
</script>
</body>
</html>
